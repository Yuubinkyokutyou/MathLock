## Chrome拡張機能「サイトアクセス計算ゲート」仕様書

### 1. 概要
指定されたWebサイトにアクセスする際に、暗算問題を連続正解しないとサイトを閲覧できないようにするChrome拡張機能。

### 2. 機能要件

#### 2.1 サイトブロック機能
- **ブラックリスト方式**
  - 正規表現でURLパターンを指定
  - 例：`^https://.*\.youtube\.com/.*`
- **ホワイトリスト機能**
  - ブラックリストに該当するサイト内の特定URLを除外
  - 正規表現で指定

#### 2.2 問題表示機能
- **トリガー条件**
  - ページ遷移時のみ（同一ページ内でのスクロールやAjax更新では発生しない）
- **表示方法**
  - モーダルポップアップで全画面をオーバーレイ
  - 背景のサイトは見えないようにブラー処理
- **問題生成**
  - インターフェース化により、問題プロバイダーを差し替え可能な設計
- **連続正解システム**
  - 設定された問題数を連続で正解する必要がある
  - 不正解時は連続正解カウントがリセットされ、新しい問題が出題される
  - 進捗表示（例：2/3問正解）

#### 2.3 アクセス許可機能
- **時間指定**
  - 全問正解後、指定時間（分単位）だけ**ドメイン全体**のアクセスを許可
  - デフォルト：15分
  - 設定範囲：1分〜120分
- **許可範囲**
  - ドメイン単位での許可（例：youtube.com全体）

#### 2.4 問題設定
- **出題数**
  - 連続正解が必要な問題数
  - デフォルト：3問
  - 設定範囲：1問〜10問
- **難易度レベル**
  - レベル1：1桁の四則演算
  - レベル2：2桁の四則演算
  - レベル3：3桁の四則演算
- **演算種別**
  - 足し算、引き算、掛け算、割り算を個別にON/OFF可能

#### 2.5 コンテキストメニュー機能
- **右クリックメニュー項目**
  - 「このドメインをブロックリストに追加」
  - 「このURLをブロックリストに追加」
  - 「このURLをホワイトリストに追加」

#### 2.6 データ同期
- Chrome Sync APIを使用して設定を複数デバイス間で同期

### 3. データ構造

```javascript
// 設定データ（Chrome Syncで同期）
{
  blacklist: [
    {
      id: string,
      pattern: string,  // 正規表現パターン
      enabled: boolean,
      createdAt: timestamp
    }
  ],
  whitelist: [
    {
      id: string,
      pattern: string,
      enabled: boolean,
      createdAt: timestamp
    }
  ],
  problemConfig: {
    requiredCount: number,  // 連続正解が必要な問題数 (1-10)
    difficulty: number,     // 1-3
    operations: {
      addition: boolean,
      subtraction: boolean,
      multiplication: boolean,
      division: boolean
    }
  },
  accessDuration: number  // 分単位
}

// 一時的なアクセス許可データ（ローカルストレージ）
{
  tempAccess: {
    [domain: string]: {
      until: timestamp
    }
  }
}

// 現在の問題解答状態（セッションストレージ）
{
  currentChallenge: {
    domain: string,
    correctCount: number,    // 現在の連続正解数
    requiredCount: number,   // 必要な連続正解数
    currentProblem: {
      question: string,
      answer: number
    }
  }
}
```

### 4. アーキテクチャ設計

#### 4.1 コンポーネント構成
```
├── manifest.json
├── background/
│   └── background.js       // サービスワーカー
├── content/
│   ├── content.js         // コンテンツスクリプト
│   └── modal.js           // モーダル制御
├── popup/
│   ├── popup.html         // 拡張機能ポップアップ
│   ├── popup.js
│   └── popup.css
├── options/
│   ├── options.html       // 設定画面
│   ├── options.js
│   └── options.css
├── lib/
│   ├── storage.js         // ストレージ管理
│   ├── urlMatcher.js     // URL判定ロジック
│   └── problem/
│       ├── ProblemProvider.js      // 抽象クラス
│       └── MathProblemProvider.js  // 数学問題実装
└── styles/
    └── modal.css
```

#### 4.2 問題プロバイダーインターフェース
```javascript
class ProblemProvider {
  // 問題生成
  generateProblem(config) {
    // return { question: string, answer: any }
  }
  
  // 解答検証
  validateAnswer(problem, userAnswer) {
    // return boolean
  }
  
  // 問題の表示形式
  formatQuestion(problem) {
    // return string
  }
}

class MathProblemProvider extends ProblemProvider {
  generateProblem(config) {
    // 難易度と演算種別に基づいて問題生成
  }
  
  validateAnswer(problem, userAnswer) {
    // 数値の比較
    return problem.answer === parseInt(userAnswer);
  }
}
```

### 5. UI仕様

#### 5.1 問題表示モーダル
```
┌─────────────────────────────────────┐
│  サイトアクセスチャレンジ           │
│                                     │
│  進捗: ●●○ (2/3問正解)            │
│                                     │
│  問題:                              │
│  ┌─────────────────────────────┐   │
│  │     47 + 28 = ?             │   │
│  └─────────────────────────────┘   │
│                                     │
│  解答: [        ]                   │
│                                     │
│  [送信] [前のページに戻る]          │
└─────────────────────────────────────┘
```

#### 5.2 設定画面構成
- **基本設定タブ**
  - 連続正解必要数：[スライダー 1-10]
  - アクセス許可時間：[数値入力] 分
  
- **問題設定タブ**
  - 難易度：[ラジオボタン レベル1/2/3]
  - 演算種別：[チェックボックス群]
  
- **ブラックリストタブ**
  - リスト表示（有効/無効切替、編集、削除）
  - 新規追加フォーム
  
- **ホワイトリストタブ**
  - リスト表示（有効/無効切替、編集、削除）
  - 新規追加フォーム

### 6. 処理フロー

#### 6.1 ページアクセス時
```mermaid
1. ページ遷移検知
2. URLがブラックリストに該当？
   → No: 通常表示
   → Yes: 3へ
3. URLがホワイトリストに該当？
   → Yes: 通常表示
   → No: 4へ
4. ドメインの一時アクセス許可が有効？
   → Yes: 通常表示
   → No: 5へ
5. 問題モーダル表示
6. 問題生成・表示
7. 解答待機
```

#### 6.2 解答処理
```mermaid
1. 解答受信
2. 正解判定
   → 不正解: 連続正解カウントリセット、新問題表示
   → 正解: 3へ
3. 連続正解カウント増加
4. 必要数に到達？
   → No: 新問題表示
   → Yes: 5へ
5. ドメインの一時アクセス許可を付与
6. モーダルを閉じてページ表示
```

### 7. 初期状態
- インストール直後は空の状態（ブラックリスト・ホワイトリスト共に未登録）
- デフォルト設定：
  - 連続正解必要数：3問
  - 難易度：レベル1
  - 演算種別：全てON
  - アクセス許可時間：15分

### 8. セキュリティ考慮事項
- Content Security Policy対応
- XSS対策（ユーザー入力のサニタイゼーション）
- 正規表現のバリデーション（ReDoS攻撃防止）

### 9. パフォーマンス考慮事項
- URLマッチング処理の最適化（キャッシュ利用）
- 大量のブラックリスト登録時の処理速度維持
- Chrome Sync使用時のデータ量制限（100KB以内）